include:
  - project: 'common/gitlab-ci'
    ref: v0.4.15
    file: '/templates/npm-package.yml'

variables:
  DOCKER_HOST: tcp://docker:2375/
  DOCKER_DRIVER: overlay2

e2e_test:
  stage: test
  image: registry.kyso.io/docker/node-builder:16.15.1-alpine3.16
  before_script:
    - !reference [.npm-config, before_script]
  services:
    - name: mongo:latest
      alias: mongo-test
      variables:
        MONGO_INITDB_ROOT_USERNAME: kadmin
        MONGO_INITDB_ROOT_PASSWORD: ksecret
  
  script:
    - export STORE_ENV_PATH=$PWD/test/.env
    - docker version
    - docker run -d -v $STORE_ENV_PATH:/secrets/kyso-api/env \
      -p 4000:4000 -e DOTENV_FILE=/secrets/kyso-api/env --network=host \
      registry.kyso.io/kyso-io/kyso-api/develop:latest
    - sleep 60
    - npm install
    - npm run test